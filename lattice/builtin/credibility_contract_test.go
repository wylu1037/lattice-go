package builtin

import (
	"github.com/stretchr/testify/assert"
	"github.com/wylu1037/lattice-go/common/convert"
	"testing"
)

func TestCredibilityContract_Write(t *testing.T) {
	contract := NewCredibilityContract()
	addr, _ := convert.ZltcToAddress("zltc_YBomBNykwMqxm719giBL3VtYV4ABT9a8D")
	println("addr:", addr.Hex())
	data, err := contract.Write(&WriteLedgerRequest{
		ProtocolUri: 8589934595,
		Hash:        "1",
		Data:        convert.BytesToBytes32Arr([]byte{1, 2, 3, 4, 5, 6, 7, 8}),
		Address:     addr,
	})
	println("Data:", convert.BytesToBytes32Arr([]byte{1, 2, 3, 4, 5, 6, 7, 8}))
	assert.NoError(t, err)
	expectData := "0x4131ff530000000000000000000000000000000000000000000000000000000200000003000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000561717f7922a233720ae38acaa4174cda0bf17660000000000000000000000000000000000000000000000000000000000000001310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010102030405060708000000000000000000000000000000000000000000000000"
	assert.Equal(t, expectData, data)
}

func TestCredibilityContract_BatchWrite(t *testing.T) {
	contract := NewCredibilityContract()
	addr, _ := convert.ZltcToAddress("zltc_YBomBNykwMqxm719giBL3VtYV4ABT9a8D")
	batchRequest := make([]WriteLedgerRequest, 1)
	batchRequest[0] = WriteLedgerRequest{
		ProtocolUri: 8589934595,
		Hash:        "1",
		Data:        convert.BytesToBytes32Arr([]byte{1, 2, 3, 4, 5, 6, 7, 8}),
		Address:     addr,
	}
	data, err := contract.BatchWrite(batchRequest)
	assert.NoError(t, err)
	expectData := "0x77b34b730000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000200000003000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000561717f7922a233720ae38acaa4174cda0bf17660000000000000000000000000000000000000000000000000000000000000001310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010102030405060708000000000000000000000000000000000000000000000000"
	assert.Equal(t, expectData, data)
}

func TestCredibilityContract_BatchCreateProtocol(t *testing.T) {
	contract := NewCredibilityContract()
	request := make([]CreateProtocolRequest, 2)
	request[0] = CreateProtocolRequest{
		10,
		convert.BytesToBytes32Arr([]byte("syntax = \"proto3\";\n\nmessage Student {\n\tstring id = 1;\n\tstring name = 2;\n}")),
	}
	request[1] = CreateProtocolRequest{
		10,
		convert.BytesToBytes32Arr([]byte("syntax = \"proto3\";\n\nmessage Student {\n\tstring id = 1;\n\tstring name = 2;\n}")),
	}
	data, err := contract.BatchCreateProtocol(request)
	assert.NoError(t, err)
	expectData := "0x589960aa0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000373796e746178203d202270726f746f33223b0a0a6d6573736167652053747564656e74207b0a09737472696e67206964203d20313b0a09737472696e67206e616d65203d20323b0a7d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000373796e746178203d202270726f746f33223b0a0a6d6573736167652053747564656e74207b0a09737472696e67206964203d20313b0a09737472696e67206e616d65203d20323b0a7d0000000000000000000000000000000000000000000000"
	assert.Equal(t, expectData, data)
}

func TestCredibilityContract_BatchUpdateProtocol(t *testing.T) {
	contract := NewCredibilityContract()
	request := make([]UpdateProtocolRequest, 1)
	request[0] = UpdateProtocolRequest{
		ProtocolUri: 8589934595,
		Data:        convert.BytesToBytes32Arr([]byte("syntax = \"proto3\";\n\nmessage Student {\n\tstring id = 1;\n\tstring name = 2;\n}")),
	}
	data, err := contract.BatchUpdateProtocol(request)
	assert.NoError(t, err)
	expectData := "0x344b37ce00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000002000000030000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000373796e746178203d202270726f746f33223b0a0a6d6573736167652053747564656e74207b0a09737472696e67206964203d20313b0a09737472696e67206e616d65203d20323b0a7d0000000000000000000000000000000000000000000000"
	assert.Equal(t, expectData, data)
}
